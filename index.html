<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0a0f">
<meta name="description" content="FitForge AI - Your personal AI fitness & diet coach">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FitForge">
<link rel="manifest" href="manifest.json">
<title>FitForge AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,300&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #08080e;
  --surface: #111118;
  --surface2: #1a1a24;
  --surface3: #22222e;
  --border: #2a2a38;
  --accent: #00e5a0;
  --accent2: #7c3aed;
  --accent3: #f59e0b;
  --text: #f0f0f8;
  --text2: #9090a8;
  --text3: #5a5a72;
  --danger: #ef4444;
  --radius: 16px;
  --radius-sm: 10px;
  --font: 'DM Sans', sans-serif;
  --mono: 'Space Mono', monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  font-family:var(--font);
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}
/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* Layout */
.app{display:flex;flex-direction:column;min-height:100vh;max-width:480px;margin:0 auto;position:relative}
.screen{display:none;flex-direction:column;flex:1;animation:fadeIn .3s ease}
.screen.active{display:flex}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* Nav */
.bottom-nav{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:480px;
  background:rgba(17,17,24,0.96);
  backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  display:flex;padding:10px 0 calc(10px + env(safe-area-inset-bottom));
  z-index:100;
}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;
  cursor:pointer;padding:4px;transition:all .2s;
  border:none;background:none;color:var(--text3);
}
.nav-item.active{color:var(--accent)}
.nav-item svg{width:22px;height:22px;transition:transform .2s}
.nav-item.active svg{transform:scale(1.1)}
.nav-item span{font-size:10px;font-weight:500;letter-spacing:.5px;text-transform:uppercase}

/* Page header */
.page-header{
  padding:60px 20px 20px;
  background:linear-gradient(180deg,rgba(0,229,160,.06) 0%,transparent 100%);
}
.page-header h1{font-size:28px;font-weight:700;letter-spacing:-.5px}
.page-header p{color:var(--text2);margin-top:4px;font-size:14px}

/* Cards */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  transition:border-color .2s;
}
.card:hover{border-color:var(--border)}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:14px 24px;border-radius:100px;font-family:var(--font);
  font-size:15px;font-weight:600;cursor:pointer;transition:all .2s;
  border:none;text-decoration:none;
}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{background:#00ffb3;transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,229,160,.25)}
.btn-primary:active{transform:translateY(0)}
.btn-ghost{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface3);border-color:var(--text3)}
.btn-danger{background:rgba(239,68,68,.15);color:var(--danger);border:1px solid rgba(239,68,68,.3)}
.btn-sm{padding:8px 16px;font-size:13px}
.btn-full{width:100%}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* Form */
.form-group{margin-bottom:20px}
.form-label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:8px;display:block}
.form-input{
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:14px 16px;color:var(--text);
  font-family:var(--font);font-size:15px;transition:all .2s;outline:none;
}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,229,160,.1)}
.form-input::placeholder{color:var(--text3)}
select.form-input{appearance:none;cursor:pointer}
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Tags */
.tag{
  display:inline-flex;align-items:center;padding:4px 12px;
  border-radius:100px;font-size:12px;font-weight:600;
}
.tag-green{background:rgba(0,229,160,.15);color:var(--accent)}
.tag-purple{background:rgba(124,58,237,.2);color:#a78bfa}
.tag-amber{background:rgba(245,158,11,.15);color:var(--accent3)}
.tag-red{background:rgba(239,68,68,.15);color:#f87171}

/* Progress */
.progress-bar{height:4px;background:var(--surface3);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),#00c4ff);border-radius:4px;transition:width .4s ease}

/* Spinner */
.spinner{
  width:40px;height:40px;border:3px solid var(--surface3);
  border-top-color:var(--accent);border-radius:50%;
  animation:spin .8s linear infinite;margin:0 auto;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Chips */
.chip-group{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{
  padding:8px 16px;border-radius:100px;border:1px solid var(--border);
  font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;
  background:transparent;color:var(--text2);
}
.chip.active{background:rgba(0,229,160,.12);border-color:var(--accent);color:var(--accent)}

/* ===================== ONBOARDING ===================== */
#screen-onboard{
  background:radial-gradient(ellipse at 20% 20%,rgba(0,229,160,.08) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 80%,rgba(124,58,237,.08) 0%,transparent 60%),var(--bg);
  padding:0;
  justify-content:center;
}
.onboard-wrap{padding:40px 24px;display:flex;flex-direction:column;min-height:100vh}
.onboard-logo{
  font-family:var(--mono);font-size:13px;color:var(--accent);
  letter-spacing:4px;text-transform:uppercase;margin-bottom:48px;
}
.onboard-step{display:none;flex-direction:column;flex:1}
.onboard-step.active{display:flex;animation:fadeIn .3s ease}
.onboard-step-num{font-family:var(--mono);font-size:11px;color:var(--text3);margin-bottom:12px}
.onboard-step h2{font-size:26px;font-weight:700;letter-spacing:-.4px;margin-bottom:8px;line-height:1.2}
.onboard-step p{color:var(--text2);font-size:14px;margin-bottom:32px;line-height:1.6}
.onboard-actions{display:flex;gap:12px;margin-top:auto;padding-top:24px}
.step-dots{display:flex;gap:6px;justify-content:center;margin-bottom:20px}
.step-dot{width:6px;height:6px;border-radius:50%;background:var(--surface3);transition:all .3s}
.step-dot.active{background:var(--accent);width:20px;border-radius:4px}

/* Hero */
.hero-icon{
  width:80px;height:80px;background:linear-gradient(135deg,var(--accent),#00a572);
  border-radius:24px;display:flex;align-items:center;justify-content:center;
  margin-bottom:32px;box-shadow:0 16px 48px rgba(0,229,160,.25);
  font-size:36px;
}

/* Gender select */
.gender-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.gender-card{
  background:var(--surface2);border:2px solid var(--border);
  border-radius:var(--radius);padding:20px;text-align:center;
  cursor:pointer;transition:all .2s;
}
.gender-card.active{border-color:var(--accent);background:rgba(0,229,160,.08)}
.gender-card .icon{font-size:32px;margin-bottom:8px}
.gender-card span{font-size:14px;font-weight:600}

/* Slider */
.slider-wrap{position:relative;padding:20px 0}
.range-slider{
  width:100%;height:6px;appearance:none;background:var(--surface3);
  border-radius:4px;outline:none;cursor:pointer;
}
.range-slider::-webkit-slider-thumb{
  appearance:none;width:24px;height:24px;border-radius:50%;
  background:var(--accent);cursor:pointer;box-shadow:0 0 12px rgba(0,229,160,.4);
}
.slider-val{
  text-align:center;font-family:var(--mono);font-size:36px;
  font-weight:700;color:var(--accent);margin-bottom:8px;
}
.slider-unit{font-size:14px;color:var(--text2);margin-left:4px}

/* ===================== HOME ===================== */
#screen-home{padding-bottom:80px}
.home-greeting{padding:52px 20px 0}
.home-greeting .time{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:2px;margin-bottom:4px}
.home-greeting h1{font-size:26px;font-weight:700}
.home-greeting span{color:var(--accent)}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:20px;margin-top:4px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:14px;text-align:center;
}
.stat-card .val{font-family:var(--mono);font-size:22px;font-weight:700;color:var(--accent)}
.stat-card .lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-top:2px}
.section{padding:0 20px;margin-bottom:24px}
.section-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.section-head h2{font-size:18px;font-weight:700}
.section-head a{font-size:13px;color:var(--accent);cursor:pointer;text-decoration:none}

/* Workout day card */
.workout-day-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px;margin-bottom:12px;
  cursor:pointer;transition:all .2s;position:relative;overflow:hidden;
}
.workout-day-card::before{
  content:'';position:absolute;top:0;left:0;width:3px;height:100%;
  background:var(--accent);opacity:0;transition:opacity .2s;
}
.workout-day-card:hover::before{opacity:1}
.workout-day-card:hover{border-color:rgba(0,229,160,.3);transform:translateX(2px)}
.wdc-top{display:flex;justify-content:space-between;align-items:start}
.wdc-title{font-size:16px;font-weight:700}
.wdc-sub{font-size:13px;color:var(--text2);margin-top:2px}
.wdc-meta{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

/* ===================== WORKOUT ===================== */
#screen-workout{padding-bottom:80px}
.ex-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);margin:0 20px 12px;overflow:hidden;
  transition:all .2s;
}
.ex-card-header{
  padding:16px;display:flex;gap:12px;align-items:center;cursor:pointer;
}
.ex-card-header:hover{background:var(--surface2)}
.ex-num{
  width:36px;height:36px;background:rgba(0,229,160,.12);
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);font-size:13px;font-weight:700;color:var(--accent);
  flex-shrink:0;
}
.ex-info{flex:1}
.ex-name{font-size:15px;font-weight:600}
.ex-detail{font-size:12px;color:var(--text2);margin-top:2px}
.ex-body{padding:0 16px 16px;display:none}
.ex-body.open{display:block;animation:fadeIn .2s ease}
.video-wrap{
  border-radius:var(--radius-sm);overflow:hidden;
  background:#000;aspect-ratio:9/16;max-height:300px;
  margin-bottom:12px;position:relative;
}
.video-wrap iframe{width:100%;height:100%;border:none}
.video-placeholder{
  width:100%;height:100%;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:12px;
  background:var(--surface3);color:var(--text2);font-size:13px;
}
.play-btn{
  width:56px;height:56px;background:rgba(255,255,255,.15);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .2s;border:2px solid rgba(255,255,255,.3);
}
.play-btn:hover{background:rgba(255,255,255,.25);transform:scale(1.05)}
.ex-tips{background:var(--surface2);border-radius:var(--radius-sm);padding:12px;font-size:13px;color:var(--text2);line-height:1.6}
.sets-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.set-item{background:var(--surface3);border-radius:8px;padding:10px;text-align:center}
.set-item .sv{font-family:var(--mono);font-size:16px;font-weight:700}
.set-item .sl{font-size:10px;color:var(--text3);text-transform:uppercase;margin-top:2px}

/* ===================== DIET/CALORIES ===================== */
#screen-diet{padding-bottom:80px}
.macro-ring{
  display:flex;justify-content:center;align-items:center;
  padding:20px;
}
.ring-chart{position:relative;width:160px;height:160px}
.ring-chart svg{transform:rotate(-90deg)}
.ring-center{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  text-align:center;
}
.ring-center .cal-val{font-family:var(--mono);font-size:26px;font-weight:700}
.ring-center .cal-lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px}
.macro-legend{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;padding:0 20px 20px}
.ml-item{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:500}
.ml-dot{width:10px;height:10px;border-radius:50%}
.macro-bars{padding:0 20px 20px}
.macro-bar-item{margin-bottom:12px}
.mb-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.mb-name{font-size:13px;font-weight:500}
.mb-val{font-family:var(--mono);font-size:12px;color:var(--text2)}

/* Food search */
.food-search-wrap{padding:0 20px;margin-bottom:16px;position:relative}
.food-results{
  position:absolute;top:calc(100% + 4px);left:20px;right:20px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--radius-sm);z-index:50;max-height:240px;
  overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,.5);
}
.food-result-item{
  padding:12px 16px;cursor:pointer;display:flex;
  justify-content:space-between;align-items:center;
  border-bottom:1px solid var(--border);transition:background .15s;
}
.food-result-item:last-child{border-bottom:none}
.food-result-item:hover{background:var(--surface3)}
.fri-name{font-size:14px;font-weight:500}
.fri-cal{font-size:12px;color:var(--accent);font-family:var(--mono)}

/* Food log */
.food-log{padding:0 20px}
.log-item{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:14px;margin-bottom:8px;
  display:flex;justify-content:space-between;align-items:center;
}
.li-info .name{font-size:14px;font-weight:600}
.li-info .detail{font-size:12px;color:var(--text2);margin-top:2px}
.li-right{text-align:right}
.li-cal{font-family:var(--mono);font-size:16px;font-weight:700;color:var(--accent)}
.li-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;margin-left:12px;transition:color .2s}
.li-del:hover{color:var(--danger)}

/* Qty modal */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:200;backdrop-filter:blur(4px);opacity:0;
  pointer-events:none;transition:opacity .2s;
}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal-sheet{
  background:var(--surface);border:1px solid var(--border);
  border-radius:24px 24px 0 0;padding:24px;width:100%;
  max-width:480px;transform:translateY(30px);transition:transform .3s;
}
.modal-overlay.open .modal-sheet{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:4px;margin:0 auto 20px}

/* ===================== AI CHAT ===================== */
#screen-ai{padding-bottom:80px}
.chat-area{
  flex:1;overflow-y:auto;padding:20px;
  display:flex;flex-direction:column;gap:16px;
}
.msg{display:flex;gap:10px;max-width:88%}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg-bubble{
  padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.6;
}
.msg.ai .msg-bubble{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:18px 18px 18px 4px;
}
.msg.user .msg-bubble{
  background:var(--accent);color:#000;font-weight:500;
  border-radius:18px 18px 4px 18px;
}
.msg-avatar{
  width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent2),var(--accent));
  display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;
}
.chat-input-wrap{
  padding:12px 16px calc(12px + env(safe-area-inset-bottom));
  background:var(--surface);border-top:1px solid var(--border);
  display:flex;gap:10px;align-items:flex-end;position:sticky;bottom:70px;
}
.chat-input{
  flex:1;background:var(--surface2);border:1px solid var(--border);
  border-radius:24px;padding:12px 16px;color:var(--text);
  font-family:var(--font);font-size:14px;outline:none;resize:none;
  max-height:100px;transition:border-color .2s;line-height:1.5;
}
.chat-input:focus{border-color:var(--accent)}
.send-btn{
  width:44px;height:44px;border-radius:50%;background:var(--accent);
  border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:all .2s;
}
.send-btn:hover{background:#00ffb3;transform:scale(1.05)}
.send-btn:disabled{opacity:.5;transform:none;cursor:not-allowed}
.ai-avatar{
  width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent2),var(--accent));
  display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;
}
.typing-dots span{
  display:inline-block;width:6px;height:6px;border-radius:50%;
  background:var(--text3);animation:dot .6s infinite alternate;
}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes dot{from{transform:translateY(0);opacity:.5}to{transform:translateY(-4px);opacity:1}}

/* Quick chips */
.quick-chips{padding:8px 16px;display:flex;gap:8px;overflow-x:auto;scrollbar-width:none}
.quick-chips::-webkit-scrollbar{display:none}
.qchip{
  white-space:nowrap;padding:8px 14px;border-radius:100px;
  border:1px solid var(--border);background:var(--surface2);
  font-size:12px;color:var(--text2);cursor:pointer;transition:all .2s;flex-shrink:0;
}
.qchip:hover{border-color:var(--accent);color:var(--accent)}

/* ===================== API KEY ===================== */
.api-banner{
  margin:20px;padding:16px;border-radius:var(--radius);
  background:rgba(124,58,237,.1);border:1px solid rgba(124,58,237,.3);
  font-size:13px;color:var(--text2);line-height:1.6;
}
.api-banner a{color:#a78bfa;text-decoration:none}
.api-banner strong{color:var(--text)}

/* Loading overlay */
#loading-overlay{
  position:fixed;inset:0;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:20px;z-index:300;
  transition:opacity .4s;
}
#loading-overlay.hidden{opacity:0;pointer-events:none}
.loading-logo{font-family:var(--mono);font-size:24px;color:var(--accent);letter-spacing:4px}
.loading-sub{font-size:13px;color:var(--text2)}

/* Install banner */
.install-banner{
  margin:12px 20px;padding:14px 16px;border-radius:var(--radius-sm);
  background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);
  display:flex;justify-content:space-between;align-items:center;
  gap:12px;
}
.install-banner-text{font-size:12px;color:var(--text2);line-height:1.5;flex:1}
.install-banner-text strong{color:var(--text)}

/* Edit workout modal */
.edit-area{
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:14px;color:var(--text);
  font-family:var(--font);font-size:14px;line-height:1.6;
  min-height:160px;resize:none;outline:none;
}
.edit-area:focus{border-color:var(--accent)}
</style>
</head>
<body>

<div id="loading-overlay">
  <div class="loading-logo">FITFORGE</div>
  <div class="spinner"></div>
  <div class="loading-sub">Initializing your forge...</div>
</div>

<div class="app" id="app">

<!-- ==================== ONBOARDING ==================== -->
<div id="screen-onboard" class="screen active">
  <div class="onboard-wrap">
    <div class="onboard-logo">FITFORGE / AI</div>

    <!-- Step 0: Welcome -->
    <div class="onboard-step active" id="step-0">
      <div class="hero-icon">‚ö°</div>
      <div class="onboard-step-num">01 / 05</div>
      <h2>Your AI-powered fitness coach</h2>
      <p>Get a personalized workout plan and Indian diet tracker ‚Äî all powered by AI. Let's build your profile.</p>
      <div class="step-dots" id="step-dots">
        <div class="step-dot active"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
      </div>
      <div class="onboard-actions">
        <button class="btn btn-primary btn-full" onclick="nextStep()">Get Started ‚Üí</button>
      </div>
    </div>

    <!-- Step 1: Basic info -->
    <div class="onboard-step" id="step-1">
      <div class="onboard-step-num">02 / 05</div>
      <h2>Tell us about yourself</h2>
      <p>This helps us personalize everything for you.</p>
      <div class="form-group">
        <label class="form-label">Your Name</label>
        <input class="form-input" type="text" id="inp-name" placeholder="e.g. Arjun">
      </div>
      <div class="form-group">
        <label class="form-label">Biological Sex</label>
        <div class="gender-grid">
          <div class="gender-card active" id="g-male" onclick="setGender('male')">
            <div class="icon">‚ôÇÔ∏è</div>
            <span>Male</span>
          </div>
          <div class="gender-card" id="g-female" onclick="setGender('female')">
            <div class="icon">‚ôÄÔ∏è</div>
            <span>Female</span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Age</label>
        <div class="slider-val" id="age-val">24 <span class="slider-unit">yrs</span></div>
        <input class="range-slider" type="range" min="13" max="80" value="24" oninput="updateSlider('age',this.value,'yrs')">
      </div>
      <div class="step-dots" id="step-dots-1">
        <div class="step-dot"></div><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div>
      </div>
      <div class="onboard-actions">
        <button class="btn btn-ghost" onclick="prevStep()">‚Üê Back</button>
        <button class="btn btn-primary" style="flex:1" onclick="nextStep()">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 2: Height/Weight -->
    <div class="onboard-step" id="step-2">
      <div class="onboard-step-num">03 / 05</div>
      <h2>Body measurements</h2>
      <p>Used to calculate your BMI and calorie needs.</p>
      <div class="form-group">
        <label class="form-label">Height</label>
        <div class="slider-val" id="height-val">170 <span class="slider-unit">cm</span></div>
        <input class="range-slider" type="range" min="140" max="220" value="170" oninput="updateSlider('height',this.value,'cm')">
      </div>
      <div class="form-group">
        <label class="form-label">Weight</label>
        <div class="slider-val" id="weight-val">70 <span class="slider-unit">kg</span></div>
        <input class="range-slider" type="range" min="30" max="180" value="70" oninput="updateSlider('weight',this.value,'kg')">
      </div>
      <div class="step-dots">
        <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div>
      </div>
      <div class="onboard-actions">
        <button class="btn btn-ghost" onclick="prevStep()">‚Üê Back</button>
        <button class="btn btn-primary" style="flex:1" onclick="nextStep()">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 3: Workout prefs -->
    <div class="onboard-step" id="step-3">
      <div class="onboard-step-num">04 / 05</div>
      <h2>Workout preferences</h2>
      <p>We'll build a plan that actually fits your life.</p>
      <div class="form-group">
        <label class="form-label">Days per week</label>
        <div class="slider-val" id="days-val">4 <span class="slider-unit">days</span></div>
        <input class="range-slider" type="range" min="1" max="7" value="4" oninput="updateSlider('days',this.value,'days')">
      </div>
      <div class="form-group">
        <label class="form-label">Fitness Goal</label>
        <div class="chip-group" id="goal-chips">
          <div class="chip active" onclick="toggleChip(this,'goal')">üí™ Muscle Gain</div>
          <div class="chip" onclick="toggleChip(this,'goal')">üî• Fat Loss</div>
          <div class="chip" onclick="toggleChip(this,'goal')">üèÉ Endurance</div>
          <div class="chip" onclick="toggleChip(this,'goal')">üßò Flexibility</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Equipment available</label>
        <div class="chip-group" id="equip-chips">
          <div class="chip active" onclick="toggleChip(this,'equip')">üèãÔ∏è Gym</div>
          <div class="chip" onclick="toggleChip(this,'equip')">üè† Home</div>
          <div class="chip" onclick="toggleChip(this,'equip')">üéΩ Bodyweight</div>
        </div>
      </div>
      <div class="step-dots">
        <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot active"></div><div class="step-dot"></div>
      </div>
      <div class="onboard-actions">
        <button class="btn btn-ghost" onclick="prevStep()">‚Üê Back</button>
        <button class="btn btn-primary" style="flex:1" onclick="nextStep()">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 4: API Key -->
    <div class="onboard-step" id="step-4">
      <div class="onboard-step-num">05 / 05</div>
      <h2>Connect AI</h2>
      <p>FitForge uses Claude AI to generate your plan. Add your free API key from Anthropic.</p>
      <div class="api-banner">
        <strong>Get a free API key:</strong><br>
        Visit <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ‚Üí Create account ‚Üí API Keys ‚Üí Create Key. New users get free credits.
      </div>
      <div class="form-group" style="margin-top:16px">
        <label class="form-label">Anthropic API Key</label>
        <input class="form-input" type="password" id="inp-apikey" placeholder="sk-ant-...">
      </div>
      <div style="font-size:12px;color:var(--text3);line-height:1.5">üîí Your key is stored only on this device and never shared.</div>
      <div class="step-dots">
        <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot active"></div>
      </div>
      <div class="onboard-actions">
        <button class="btn btn-ghost" onclick="prevStep()">‚Üê Back</button>
        <button class="btn btn-primary" style="flex:1" id="gen-btn" onclick="generatePlan()">‚ö° Generate My Plan</button>
      </div>
    </div>

  </div>
</div>

<!-- ==================== HOME ==================== -->
<div id="screen-home" class="screen">
  <div id="install-banner" class="install-banner" style="display:none">
    <div class="install-banner-text"><strong>Install App</strong> ‚Äî Add to home screen for offline access</div>
    <button class="btn btn-primary btn-sm" onclick="installApp()">Install</button>
  </div>
  <div class="home-greeting">
    <div class="time" id="greeting-time">Good morning</div>
    <h1>Hey, <span id="greeting-name">Champion</span> üëã</h1>
  </div>
  <div class="stats-row">
    <div class="stat-card">
      <div class="val" id="stat-bmi">--</div>
      <div class="lbl">BMI</div>
    </div>
    <div class="stat-card">
      <div class="val" id="stat-tdee">--</div>
      <div class="lbl">TDEE kcal</div>
    </div>
    <div class="stat-card">
      <div class="val" id="stat-streak">0</div>
      <div class="lbl">Day Streak</div>
    </div>
  </div>

  <div class="section">
    <div class="section-head">
      <h2>Your Plan</h2>
      <a onclick="showScreen('ai')">Edit with AI</a>
    </div>
    <div id="workout-plan-home">
      <div class="card" style="text-align:center;color:var(--text2);padding:32px">
        <div style="font-size:32px;margin-bottom:8px">üèãÔ∏è</div>
        <div style="font-size:14px">No plan yet ‚Äî complete setup to generate one</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-head"><h2>Today's Nutrition</h2><a onclick="showScreen('diet')">Add Food</a></div>
    <div id="home-nutrition-summary">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:13px;color:var(--text2)">Calories today</div>
            <div style="font-family:var(--mono);font-size:28px;font-weight:700;color:var(--accent)" id="home-cal-today">0</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:13px;color:var(--text2)">Goal</div>
            <div style="font-family:var(--mono);font-size:18px;font-weight:700;color:var(--text2)" id="home-cal-goal">--</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="progress-bar"><div class="progress-fill" id="home-cal-progress" style="width:0%"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== WORKOUT ==================== -->
<div id="screen-workout" class="screen">
  <div class="page-header">
    <h1>Workout Plan</h1>
    <p id="workout-subtitle">Your personalized training schedule</p>
  </div>
  <div id="workout-days-list"></div>
</div>

<!-- ==================== DIET ==================== -->
<div id="screen-diet" class="screen">
  <div class="page-header">
    <h1>Calorie Tracker</h1>
    <p>Indian diet database ‚Äî auto-calculate nutrients</p>
  </div>

  <div class="macro-ring">
    <div class="ring-chart">
      <svg width="160" height="160" viewBox="0 0 160 160">
        <circle cx="80" cy="80" r="65" fill="none" stroke="var(--surface3)" stroke-width="14"/>
        <circle cx="80" cy="80" r="65" fill="none" stroke="#00e5a0" stroke-width="14"
          stroke-dasharray="408.41" id="ring-carb" stroke-dashoffset="408.41" stroke-linecap="round"/>
        <circle cx="80" cy="80" r="52" fill="none" stroke="var(--surface3)" stroke-width="14"/>
        <circle cx="80" cy="80" r="52" fill="none" stroke="#7c3aed" stroke-width="14"
          stroke-dasharray="326.73" id="ring-prot" stroke-dashoffset="326.73" stroke-linecap="round"/>
        <circle cx="80" cy="80" r="39" fill="none" stroke="var(--surface3)" stroke-width="14"/>
        <circle cx="80" cy="80" r="39" fill="none" stroke="#f59e0b" stroke-width="14"
          stroke-dasharray="245.04" id="ring-fat" stroke-dashoffset="245.04" stroke-linecap="round"/>
      </svg>
      <div class="ring-center">
        <div class="cal-val" id="total-cal">0</div>
        <div class="cal-lbl">kcal</div>
      </div>
    </div>
  </div>

  <div class="macro-legend">
    <div class="ml-item"><div class="ml-dot" style="background:#00e5a0"></div><span id="carb-legend">Carbs 0g</span></div>
    <div class="ml-item"><div class="ml-dot" style="background:#7c3aed"></div><span id="prot-legend">Protein 0g</span></div>
    <div class="ml-item"><div class="ml-dot" style="background:#f59e0b"></div><span id="fat-legend">Fat 0g</span></div>
    <div class="ml-item"><div class="ml-dot" style="background:#ef4444"></div><span id="fiber-legend">Fiber 0g</span></div>
  </div>

  <div class="food-search-wrap">
    <input class="form-input" type="text" id="food-search" placeholder="üîç  Search Indian food... (e.g. dal, roti, paneer)" oninput="searchFood(this.value)" autocomplete="off">
    <div class="food-results" id="food-results" style="display:none"></div>
  </div>

  <div class="food-log" id="food-log"></div>

  <div style="height:16px"></div>
</div>

<!-- ==================== AI CHAT ==================== -->
<div id="screen-ai" class="screen" style="flex-direction:column">
  <div class="page-header" style="padding-bottom:12px">
    <h1>AI Coach</h1>
    <p>Modify your plan, ask nutrition questions</p>
  </div>
  <div class="quick-chips" id="quick-chips">
    <div class="qchip" onclick="sendQuick(this)">üí™ Make chest day harder</div>
    <div class="qchip" onclick="sendQuick(this)">üèÉ Add cardio days</div>
    <div class="qchip" onclick="sendQuick(this)">ü•ó Suggest high-protein diet</div>
    <div class="qchip" onclick="sendQuick(this)">üîÑ Replace squats with lunges</div>
    <div class="qchip" onclick="sendQuick(this)">üìÖ Adjust rest days</div>
  </div>
  <div class="chat-area" id="chat-area">
    <div class="msg ai">
      <div class="ai-avatar">ü§ñ</div>
      <div class="msg-bubble">Hey! I'm your AI fitness coach. I can modify your workout plan, suggest diet changes, or answer any fitness questions. What would you like to improve?</div>
    </div>
  </div>
  <div class="chat-input-wrap">
    <textarea class="chat-input" id="chat-input" placeholder="Ask anything about your plan..." rows="1" onkeydown="chatKeydown(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="send-btn" onclick="sendChat()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>

<!-- ==================== BOTTOM NAV ==================== -->
<nav class="bottom-nav" id="bottom-nav" style="display:none">
  <button class="nav-item active" onclick="showScreen('home')" id="nav-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    <span>Home</span>
  </button>
  <button class="nav-item" onclick="showScreen('workout')" id="nav-workout">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4v16M18 4v16M4 12h4M16 12h4M4 6h2M4 18h2M18 6h2M18 18h2"/></svg>
    <span>Workout</span>
  </button>
  <button class="nav-item" onclick="showScreen('diet')" id="nav-diet">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
    <span>Diet</span>
  </button>
  <button class="nav-item" onclick="showScreen('ai')" id="nav-ai">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a5 5 0 0 1 5 5v3a5 5 0 0 1-10 0V7a5 5 0 0 1 5-5z"/><path d="M3 20a9 9 0 0 1 18 0"/></svg>
    <span>AI Coach</span>
  </button>
</nav>

<!-- Qty Modal -->
<div class="modal-overlay" id="qty-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 id="modal-food-name" style="margin-bottom:16px;font-size:18px;font-weight:700"></h3>
    <div class="form-group">
      <label class="form-label">Quantity (grams)</label>
      <input class="form-input" type="number" id="modal-qty" value="100" min="1" max="2000">
    </div>
    <div id="modal-preview" style="background:var(--surface2);border-radius:var(--radius-sm);padding:14px;margin-bottom:16px;font-size:13px;color:var(--text2)"></div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeQtyModal()">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="confirmAddFood()">Add to Log</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
let state = {
  step: 0,
  profile: {name:'',sex:'male',age:24,height:170,weight:70,days:4,goal:'Muscle Gain',equipment:'Gym'},
  apiKey: '',
  workoutPlan: null,
  foodLog: [],
  chatHistory: [],
  streak: 0
};

// Indian food database (per 100g)
const FOODS = [
  {n:"Roti / Chapati",c:297,p:9,f:4,fiber:3,carb:53},
  {n:"Basmati Rice (cooked)",c:130,p:2.7,f:0.3,fiber:0.4,carb:28},
  {n:"Brown Rice (cooked)",c:111,p:2.6,f:0.9,fiber:1.8,carb:23},
  {n:"Dal Tadka",c:116,p:7,f:3,fiber:4,carb:16},
  {n:"Dal Makhani",c:150,p:9,f:6,fiber:5,carb:17},
  {n:"Chana Dal",c:164,p:10,f:2,fiber:8,carb:27},
  {n:"Moong Dal",c:105,p:7,f:0.4,fiber:4,carb:19},
  {n:"Masoor Dal",c:116,p:9,f:0.4,fiber:5,carb:20},
  {n:"Paneer",c:265,p:18,f:20,fiber:0,carb:4},
  {n:"Paneer Butter Masala",c:180,p:8,f:12,fiber:2,carb:10},
  {n:"Chole / Chana Masala",c:164,p:9,f:3,fiber:7,carb:27},
  {n:"Rajma",c:127,p:9,f:0.5,fiber:7,carb:22},
  {n:"Aloo Sabzi",c:77,p:2,f:2.5,fiber:2,carb:12},
  {n:"Bhindi Masala",c:45,p:2,f:2,fiber:3,carb:6},
  {n:"Palak Paneer",c:200,p:10,f:14,fiber:3,carb:9},
  {n:"Egg (boiled)",c:155,p:13,f:11,fiber:0,carb:1},
  {n:"Chicken Breast (cooked)",c:165,p:31,f:3.6,fiber:0,carb:0},
  {n:"Chicken Curry",c:150,p:15,f:8,fiber:1,carb:6},
  {n:"Fish Curry",c:140,p:18,f:6,fiber:0,carb:4},
  {n:"Dahi / Curd",c:61,p:3.5,f:3.3,fiber:0,carb:4.7},
  {n:"Lassi (sweet)",c:96,p:3,f:2.5,fiber:0,carb:16},
  {n:"Chaas / Buttermilk",c:40,p:3,f:1,fiber:0,carb:5},
  {n:"Idli",c:58,p:2,f:0.2,fiber:1,carb:12},
  {n:"Dosa (plain)",c:168,p:4,f:5,fiber:1,carb:28},
  {n:"Masala Dosa",c:215,p:5,f:9,fiber:2,carb:31},
  {n:"Upma",c:135,p:3,f:4,fiber:2,carb:22},
  {n:"Poha",c:130,p:3,f:2,fiber:2,carb:24},
  {n:"Sambar",c:57,p:3,f:1,fiber:4,carb:9},
  {n:"Paratha (plain)",c:297,p:7,f:10,fiber:3,carb:46},
  {n:"Paratha (stuffed aloo)",c:260,p:6,f:10,fiber:3,carb:40},
  {n:"Biryani (chicken)",c:200,p:12,f:7,fiber:1,carb:27},
  {n:"Biryani (veg)",c:170,p:5,f:5,fiber:2,carb:28},
  {n:"Naan",c:310,p:9,f:5,fiber:2,carb:56},
  {n:"Puri",c:400,p:7,f:20,fiber:2,carb:50},
  {n:"Samosa (1 piece ~50g)",c:170,p:3,f:9,fiber:2,carb:22},
  {n:"Pav Bhaji",c:175,p:5,f:7,fiber:4,carb:25},
  {n:"Vada Pav",c:290,p:7,f:11,fiber:3,carb:42},
  {n:"Kachori",c:350,p:8,f:18,fiber:3,carb:42},
  {n:"Dhokla",c:160,p:7,f:3,fiber:2,carb:28},
  {n:"Khichdi",c:120,p:5,f:2,fiber:3,carb:22},
  {n:"Pulao (veg)",c:150,p:4,f:4,fiber:2,carb:26},
  {n:"Raita",c:55,p:2.5,f:2,fiber:0.5,carb:6},
  {n:"Papad",c:336,p:21,f:6,fiber:5,carb:52},
  {n:"Pickle (mango)",c:89,p:1,f:5,fiber:2,carb:11},
  {n:"Ghee",c:900,p:0,f:99,fiber:0,carb:0},
  {n:"Coconut Chutney",c:180,p:2,f:16,fiber:4,carb:8},
  {n:"Tomato Chutney",c:60,p:1,f:2,fiber:2,carb:9},
  {n:"Milk (full fat)",c:61,p:3.2,f:3.3,fiber:0,carb:4.8},
  {n:"Toned Milk",c:46,p:3.5,f:1.5,fiber:0,carb:5},
  {n:"Paneer Tikka",c:235,p:15,f:16,fiber:1,carb:8},
  {n:"Tandoori Chicken",c:185,p:28,f:7,fiber:0,carb:5},
  {n:"Mutton Curry",c:195,p:20,f:11,fiber:0,carb:5},
  {n:"Halwa (suji)",c:300,p:4,f:12,fiber:1,carb:46},
  {n:"Kheer",c:150,p:4,f:6,fiber:0,carb:21},
  {n:"Gulab Jamun (1 piece)",c:175,p:2,f:7,fiber:0,carb:28},
  {n:"Banana",c:89,p:1.1,f:0.3,fiber:2.6,carb:23},
  {n:"Apple",c:52,p:0.3,f:0.2,fiber:2.4,carb:14},
  {n:"Mango",c:60,p:0.8,f:0.4,fiber:1.6,carb:15},
  {n:"Pomegranate",c:83,p:1.7,f:1.2,fiber:4,carb:19},
  {n:"Papaya",c:43,p:0.5,f:0.3,fiber:1.7,carb:11},
  {n:"Whey Protein (1 scoop ~30g)",c:110,p:22,f:1.5,fiber:0,carb:4},
  {n:"Almonds",c:579,p:21,f:50,fiber:12.5,carb:22},
  {n:"Cashews",c:553,p:18,f:44,fiber:3,carb:30},
  {n:"Groundnuts",c:567,p:26,f:49,fiber:8,carb:16},
  {n:"Sprouts (mixed)",c:65,p:5,f:0.5,fiber:4,carb:12},
  {n:"Soya Chunks (cooked)",c:172,p:18,f:0.5,fiber:4,carb:27},
  {n:"Tofu",c:76,p:8,f:4.8,fiber:0.3,carb:2},
  {n:"Corn (bhutta)",c:86,p:3,f:1,fiber:2,carb:19},
  {n:"Sweet Potato",c:86,p:1.6,f:0.1,fiber:3,carb:20},
];

// Exercise video data (YouTube embed IDs) - demo/instructional videos
const EXERCISE_VIDEOS = {
  "Bench Press": "rT7DgCr-3pg",
  "Push-Up": "IODxDxX7oi4",
  "Pull-Up": "eGo4IYlbE5g",
  "Squat": "aclHkVaku9U",
  "Deadlift": "op9kVnSso6Q",
  "Shoulder Press": "qEwKCR5JCog",
  "Bicep Curl": "ykJmrZ5v0Oo",
  "Tricep Dip": "0326dy_-CzM",
  "Lat Pulldown": "CAwf7n6Luuc",
  "Leg Press": "IZxyjW7MPJQ",
  "Plank": "ASdvSXt6C0o",
  "Lunges": "QOVaHwm-Q6U",
  "Dumbbell Row": "roCP6wCXPqo",
  "Incline Press": "SrqOu55lrYU",
  "Romanian Deadlift": "JCXUYuzwNrM",
  "default": "IODxDxX7oi4"
};

// ============================================================
// ONBOARDING
// ============================================================
let currentStep = 0;
const totalSteps = 5;

function nextStep() {
  if (currentStep === 0) { currentStep=1; showStep(1); return; }
  if (currentStep === 1) {
    state.profile.name = document.getElementById('inp-name').value || 'Champion';
    state.profile.age = parseInt(document.querySelector('#step-1 .range-slider').value);
  }
  if (currentStep === 2) {
    const sliders = document.querySelectorAll('#step-2 .range-slider');
    state.profile.height = parseInt(sliders[0].value);
    state.profile.weight = parseInt(sliders[1].value);
  }
  if (currentStep === 3) {
    const goalActive = document.querySelector('#goal-chips .chip.active');
    if (goalActive) state.profile.goal = goalActive.textContent.replace(/[^\w ]/g,'').trim();
    const equipActive = document.querySelector('#equip-chips .chip.active');
    if (equipActive) state.profile.equipment = equipActive.textContent.replace(/[^\w ]/g,'').trim();
    state.profile.days = parseInt(document.querySelector('#step-3 .range-slider').value);
  }
  if (currentStep < totalSteps - 1) { currentStep++; showStep(currentStep); }
}

function prevStep() {
  if (currentStep > 0) { currentStep--; showStep(currentStep); }
}

function showStep(n) {
  document.querySelectorAll('.onboard-step').forEach(s=>s.classList.remove('active'));
  document.getElementById('step-'+n).classList.add('active');
}

function setGender(g) {
  state.profile.sex = g;
  document.getElementById('g-male').classList.toggle('active', g==='male');
  document.getElementById('g-female').classList.toggle('active', g==='female');
}

function updateSlider(key, val, unit) {
  document.getElementById(key+'-val').innerHTML = val+' <span class="slider-unit">'+unit+'</span>';
  if (key==='age') state.profile.age = parseInt(val);
  if (key==='height') state.profile.height = parseInt(val);
  if (key==='weight') state.profile.weight = parseInt(val);
  if (key==='days') state.profile.days = parseInt(val);
}

function toggleChip(el, group) {
  document.querySelectorAll('#'+group+'-chips .chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
}

// ============================================================
// GENERATE PLAN
// ============================================================
async function generatePlan() {
  const key = document.getElementById('inp-apikey').value.trim();
  if (!key) { alert('Please enter your Anthropic API key'); return; }
  state.apiKey = key;
  localStorage.setItem('ff_apikey', key);

  const btn = document.getElementById('gen-btn');
  btn.disabled = true;
  btn.textContent = '‚ö° Generating...';

  const {name,sex,age,height,weight,days,goal,equipment} = state.profile;
  const bmi = (weight / ((height/100)**2)).toFixed(1);
  const tdee = calcTDEE();

  const prompt = `Create a detailed ${days}-day workout plan for:
Name: ${name}, Sex: ${sex}, Age: ${age}, Height: ${height}cm, Weight: ${weight}kg, BMI: ${bmi}
Goal: ${goal}, Equipment: ${equipment}, TDEE: ${tdee} kcal/day

Respond ONLY with valid JSON in this exact format:
{
  "weeklyPlan": [
    {
      "day": "Day 1",
      "focus": "Chest & Triceps",
      "duration": "45 min",
      "difficulty": "Intermediate",
      "exercises": [
        {
          "name": "Bench Press",
          "sets": 4,
          "reps": "8-10",
          "rest": "90 sec",
          "muscle": "Chest",
          "tips": "Keep back flat, drive feet into floor"
        }
      ]
    }
  ],
  "dietPlan": {
    "calories": ${tdee},
    "protein": ${Math.round(weight*2)},
    "carbs": ${Math.round(tdee*0.45/4)},
    "fat": ${Math.round(tdee*0.25/9)},
    "meals": ["Breakfast: 3 egg whites + 2 whole eggs + 2 rotis", "Mid-morning: 1 banana + handful almonds", "Lunch: 1 cup dal + 1 cup rice + sabzi + dahi", "Pre-workout: banana + black coffee", "Post-workout: whey protein shake", "Dinner: paneer tikka / chicken + 2 rotis + salad"]
  }
}

Include ${days} workout days (rest on remaining days). Use common exercises with proper names. Make it realistic for ${equipment} equipment.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4000,
        messages: [{role:'user', content: prompt}]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API error');
    }

    const data = await response.json();
    const text = data.content[0].text;
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('No JSON in response');

    state.workoutPlan = JSON.parse(jsonMatch[0]);
    saveState();
    initMainApp();
  } catch(e) {
    alert('Error: ' + e.message + '\n\nCheck your API key and try again.');
    btn.disabled = false;
    btn.textContent = '‚ö° Generate My Plan';
  }
}

// ============================================================
// APP INIT
// ============================================================
function calcTDEE() {
  const {sex,age,height,weight,days} = state.profile;
  let bmr = sex==='male'
    ? 88.362 + (13.397*weight) + (4.799*height) - (5.677*age)
    : 447.593 + (9.247*weight) + (3.098*height) - (4.330*age);
  const actMult = days<=2 ? 1.375 : days<=4 ? 1.55 : days<=6 ? 1.725 : 1.9;
  return Math.round(bmr * actMult);
}

function initMainApp() {
  document.getElementById('screen-onboard').classList.remove('active');
  document.getElementById('bottom-nav').style.display = 'flex';
  showScreen('home');
  updateHomeStats();
  renderWorkoutPlan();
  updateNutritionDisplay();
}

function updateHomeStats() {
  const {height,weight,name} = state.profile;
  const bmi = (weight/((height/100)**2)).toFixed(1);
  document.getElementById('stat-bmi').textContent = bmi;
  document.getElementById('stat-tdee').textContent = Math.round(calcTDEE()/1000*10)/10+'k';
  document.getElementById('stat-streak').textContent = state.streak || 0;
  document.getElementById('greeting-name').textContent = name || 'Champion';
  const h = new Date().getHours();
  document.getElementById('greeting-time').textContent = h<12 ? 'Good morning' : h<17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('home-cal-goal').textContent = calcTDEE();
}

// ============================================================
// WORKOUT RENDERING
// ============================================================
function renderWorkoutPlan() {
  if (!state.workoutPlan) return;
  const plan = state.workoutPlan.weeklyPlan;

  // Home preview
  const homeContainer = document.getElementById('workout-plan-home');
  homeContainer.innerHTML = '';
  const today = new Date().getDay(); // 0=Sun
  plan.slice(0,3).forEach((day,i) => {
    const card = document.createElement('div');
    card.className = 'workout-day-card';
    card.onclick = () => { showScreen('workout'); setTimeout(()=>toggleExercises(i),100); };
    card.innerHTML = `
      <div class="wdc-top">
        <div>
          <div class="wdc-title">${day.day} ‚Äî ${day.focus}</div>
          <div class="wdc-sub">${day.exercises?.length || 0} exercises ¬∑ ${day.duration}</div>
        </div>
        <div class="tag tag-green">${day.difficulty}</div>
      </div>
      <div class="wdc-meta">
        ${day.exercises?.slice(0,3).map(e=>`<span class="tag tag-purple">${e.name}</span>`).join('')}
        ${day.exercises?.length > 3 ? `<span class="tag" style="background:var(--surface3);color:var(--text2)">+${day.exercises.length-3} more</span>` : ''}
      </div>`;
    homeContainer.appendChild(card);
  });

  // Full workout screen
  const workoutContainer = document.getElementById('workout-days-list');
  workoutContainer.innerHTML = '';
  plan.forEach((day, dayIdx) => {
    const dayHeader = document.createElement('div');
    dayHeader.style.cssText = 'padding:8px 20px 4px;';
    dayHeader.innerHTML = `<div style="font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;font-weight:600">${day.day}</div>`;
    workoutContainer.appendChild(dayHeader);

    const dayCard = document.createElement('div');
    dayCard.innerHTML = `
      <div class="workout-day-card" style="margin:0 20px 8px;cursor:pointer" onclick="toggleDay(${dayIdx})">
        <div class="wdc-top">
          <div>
            <div class="wdc-title">${day.focus}</div>
            <div class="wdc-sub">${day.exercises?.length || 0} exercises ¬∑ ${day.duration}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <div class="tag tag-green">${day.difficulty}</div>
            <svg id="day-arrow-${dayIdx}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
      </div>`;
    workoutContainer.appendChild(dayCard);

    const exList = document.createElement('div');
    exList.id = `day-exercises-${dayIdx}`;
    exList.style.display = 'none';
    day.exercises?.forEach((ex, exIdx) => {
      const videoId = getVideoId(ex.name);
      exList.innerHTML += `
        <div class="ex-card">
          <div class="ex-card-header" onclick="toggleEx(${dayIdx},${exIdx})">
            <div class="ex-num">${String(exIdx+1).padStart(2,'0')}</div>
            <div class="ex-info">
              <div class="ex-name">${ex.name}</div>
              <div class="ex-detail">${ex.sets} sets √ó ${ex.reps} reps ¬∑ Rest ${ex.rest}</div>
            </div>
            <div class="tag tag-amber" style="font-size:10px">${ex.muscle}</div>
          </div>
          <div class="ex-body" id="ex-${dayIdx}-${exIdx}">
            <div class="sets-grid">
              <div class="set-item"><div class="sv">${ex.sets}</div><div class="sl">Sets</div></div>
              <div class="set-item"><div class="sv">${ex.reps}</div><div class="sl">Reps</div></div>
              <div class="set-item"><div class="sv">${ex.rest}</div><div class="sl">Rest</div></div>
            </div>
            <div class="video-wrap" id="vw-${dayIdx}-${exIdx}">
              <div class="video-placeholder" onclick="loadVideo(${dayIdx},${exIdx},'${videoId}')">
                <div class="play-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>
                <span>Tap to play demo</span>
                <span style="font-size:11px;color:var(--text3)">${ex.name}</span>
              </div>
            </div>
            <div class="ex-tips">üí° ${ex.tips || 'Focus on form and controlled movement.'}</div>
          </div>
        </div>`;
    });
    workoutContainer.appendChild(exList);
  });

  document.getElementById('workout-subtitle').textContent = `${plan.length} training days ¬∑ ${state.profile.goal}`;
}

function toggleDay(idx) {
  const el = document.getElementById('day-exercises-'+idx);
  const arrow = document.getElementById('day-arrow-'+idx);
  const open = el.style.display !== 'none';
  el.style.display = open ? 'none' : 'block';
  if (arrow) arrow.style.transform = open ? '' : 'rotate(180deg)';
}

function toggleExercises(idx) {
  const el = document.getElementById('day-exercises-'+idx);
  if (el) { el.style.display = 'block'; el.scrollIntoView({behavior:'smooth'}); }
}

function toggleEx(d,e) {
  const el = document.getElementById(`ex-${d}-${e}`);
  el.classList.toggle('open');
}

function getVideoId(name) {
  for (const [key, id] of Object.entries(EXERCISE_VIDEOS)) {
    if (name.toLowerCase().includes(key.toLowerCase())) return id;
  }
  return EXERCISE_VIDEOS.default;
}

function loadVideo(d,e,videoId) {
  const wrap = document.getElementById(`vw-${d}-${e}`);
  wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" allowfullscreen allow="autoplay"></iframe>`;
}

// ============================================================
// DIET / CALORIE TRACKER
// ============================================================
let selectedFood = null;
let searchTimeout = null;

function searchFood(query) {
  clearTimeout(searchTimeout);
  const results = document.getElementById('food-results');
  if (!query.trim()) { results.style.display = 'none'; return; }
  
  searchTimeout = setTimeout(() => {
    const q = query.toLowerCase();
    const matches = FOODS.filter(f => f.n.toLowerCase().includes(q)).slice(0,10);
    if (!matches.length) { results.style.display = 'none'; return; }
    
    results.style.display = 'block';
    results.innerHTML = matches.map(f => `
      <div class="food-result-item" onclick="selectFood(${JSON.stringify(f).replace(/"/g,'&quot;')})">
        <div>
          <div class="fri-name">${f.n}</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px">P:${f.p}g C:${f.carb}g F:${f.f}g per 100g</div>
        </div>
        <div class="fri-cal">${f.c} kcal</div>
      </div>`).join('');
  }, 150);
}

function selectFood(food) {
  selectedFood = food;
  document.getElementById('food-search').value = '';
  document.getElementById('food-results').style.display = 'none';
  document.getElementById('modal-food-name').textContent = food.n;
  document.getElementById('modal-qty').value = 100;
  updateModalPreview(food, 100);
  document.getElementById('qty-modal').classList.add('open');
}

document.getElementById('modal-qty').addEventListener('input', function() {
  if (selectedFood) updateModalPreview(selectedFood, parseInt(this.value) || 0);
});

function updateModalPreview(food, qty) {
  const ratio = qty / 100;
  document.getElementById('modal-preview').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center">
      <div><div style="font-family:var(--mono);font-size:18px;color:var(--accent)">${Math.round(food.c*ratio)}</div><div style="font-size:10px;text-transform:uppercase;letter-spacing:.5px">kcal</div></div>
      <div><div style="font-family:var(--mono);font-size:18px;color:#7c3aed">${(food.p*ratio).toFixed(1)}g</div><div style="font-size:10px;text-transform:uppercase;letter-spacing:.5px">protein</div></div>
      <div><div style="font-family:var(--mono);font-size:18px;color:#00e5a0">${(food.carb*ratio).toFixed(1)}g</div><div style="font-size:10px;text-transform:uppercase;letter-spacing:.5px">carbs</div></div>
      <div><div style="font-family:var(--mono);font-size:18px;color:#f59e0b">${(food.f*ratio).toFixed(1)}g</div><div style="font-size:10px;text-transform:uppercase;letter-spacing:.5px">fat</div></div>
    </div>`;
}

function closeQtyModal() {
  document.getElementById('qty-modal').classList.remove('open');
  selectedFood = null;
}

function confirmAddFood() {
  if (!selectedFood) return;
  const qty = parseInt(document.getElementById('modal-qty').value) || 100;
  const ratio = qty / 100;
  state.foodLog.push({
    name: selectedFood.n,
    qty,
    cal: Math.round(selectedFood.c * ratio),
    protein: parseFloat((selectedFood.p * ratio).toFixed(1)),
    carb: parseFloat((selectedFood.carb * ratio).toFixed(1)),
    fat: parseFloat((selectedFood.f * ratio).toFixed(1)),
    fiber: parseFloat((selectedFood.fiber * ratio).toFixed(1)),
    id: Date.now()
  });
  saveState();
  closeQtyModal();
  renderFoodLog();
  updateNutritionDisplay();
}

function removeFood(id) {
  state.foodLog = state.foodLog.filter(f => f.id !== id);
  saveState();
  renderFoodLog();
  updateNutritionDisplay();
}

function renderFoodLog() {
  const container = document.getElementById('food-log');
  if (!state.foodLog.length) {
    container.innerHTML = `<div class="card" style="text-align:center;color:var(--text2);padding:24px">
      <div style="font-size:28px;margin-bottom:8px">ü•ó</div>
      <div style="font-size:14px">Search and add foods above to start tracking</div>
    </div>`;
    return;
  }
  container.innerHTML = state.foodLog.map(f => `
    <div class="log-item">
      <div class="li-info">
        <div class="name">${f.name}</div>
        <div class="detail">${f.qty}g ¬∑ P:${f.protein}g ¬∑ C:${f.carb}g ¬∑ F:${f.fat}g ¬∑ Fiber:${f.fiber}g</div>
      </div>
      <div style="display:flex;align-items:center">
        <div class="li-right"><div class="li-cal">${f.cal}</div><div style="font-size:10px;color:var(--text3)">kcal</div></div>
        <button class="li-del" onclick="removeFood(${f.id})">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        </button>
      </div>
    </div>`).join('');
}

function updateNutritionDisplay() {
  const totals = state.foodLog.reduce((a,f) => ({
    cal: a.cal+f.cal, protein: a.protein+f.protein,
    carb: a.carb+f.carb, fat: a.fat+f.fat, fiber: a.fiber+f.fiber
  }), {cal:0,protein:0,carb:0,fat:0,fiber:0});

  const tdee = calcTDEE();
  document.getElementById('total-cal').textContent = Math.round(totals.cal);
  document.getElementById('carb-legend').textContent = `Carbs ${totals.carb.toFixed(0)}g`;
  document.getElementById('prot-legend').textContent = `Protein ${totals.protein.toFixed(0)}g`;
  document.getElementById('fat-legend').textContent = `Fat ${totals.fat.toFixed(0)}g`;
  document.getElementById('fiber-legend').textContent = `Fiber ${totals.fiber.toFixed(0)}g`;

  // Ring chart
  const carbPct = Math.min(totals.cal / tdee, 1);
  const protPct = Math.min(totals.protein*4 / tdee, 1);
  const fatPct = Math.min(totals.fat*9 / tdee, 1);
  document.getElementById('ring-carb').style.strokeDashoffset = 408.41 * (1 - carbPct);
  document.getElementById('ring-prot').style.strokeDashoffset = 326.73 * (1 - protPct);
  document.getElementById('ring-fat').style.strokeDashoffset = 245.04 * (1 - fatPct);

  // Home update
  document.getElementById('home-cal-today').textContent = Math.round(totals.cal);
  document.getElementById('home-cal-goal').textContent = tdee;
  const pct = Math.min((totals.cal / tdee) * 100, 100);
  document.getElementById('home-cal-progress').style.width = pct + '%';
}

// ============================================================
// AI CHAT
// ============================================================
async function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  if (!state.apiKey) {
    appendMsg('ai', "Please set up your API key first by going through the setup again.");
    return;
  }

  input.value = '';
  autoResize(input);
  appendMsg('user', text);
  state.chatHistory.push({role:'user', content: text});

  const typingId = appendTyping();
  document.getElementById('send-btn').disabled = true;

  try {
    const systemPrompt = `You are an expert personal fitness trainer and nutritionist AI coach. 
The user has this profile: ${JSON.stringify(state.profile)}.
Current workout plan: ${state.workoutPlan ? JSON.stringify(state.workoutPlan.weeklyPlan?.map(d=>({day:d.day,focus:d.focus,exercises:d.exercises?.map(e=>e.name)}))) : 'Not generated yet'}.
Help them modify their workout plan, answer nutrition questions about Indian diet, and provide fitness advice.
When modifying the workout plan, clearly describe the changes. Be concise, practical, and motivating.
If they ask to change the plan, describe the changes clearly and mention you've updated it.`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: state.chatHistory.slice(-10)
      })
    });

    const data = await response.json();
    const reply = data.content?.[0]?.text || 'Sorry, I could not process that.';
    removeTyping(typingId);
    appendMsg('ai', reply);
    state.chatHistory.push({role:'assistant', content: reply});
    saveState();
  } catch(e) {
    removeTyping(typingId);
    appendMsg('ai', 'Connection error. Please check your API key and internet connection.');
  }
  document.getElementById('send-btn').disabled = false;
}

function appendMsg(role, text) {
  const area = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = `
    ${role==='ai' ? '<div class="ai-avatar">ü§ñ</div>' : ''}
    <div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>`;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
  return div;
}

function appendTyping() {
  const area = document.getElementById('chat-area');
  const id = 'typing-' + Date.now();
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = id;
  div.innerHTML = `<div class="ai-avatar">ü§ñ</div><div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
  return id;
}

function removeTyping(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function chatKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function sendQuick(el) {
  document.getElementById('chat-input').value = el.textContent.replace(/^[^\w]*/,'').trim();
  sendChat();
}

// ============================================================
// NAVIGATION
// ============================================================
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById('nav-' + name);
  if (navEl) navEl.classList.add('active');
  
  if (name === 'diet') { renderFoodLog(); updateNutritionDisplay(); }
}

// ============================================================
// PERSISTENCE
// ============================================================
function saveState() {
  try {
    localStorage.setItem('ff_state', JSON.stringify({
      profile: state.profile,
      apiKey: state.apiKey,
      workoutPlan: state.workoutPlan,
      foodLog: state.foodLog,
      chatHistory: state.chatHistory.slice(-20),
      streak: state.streak
    }));
  } catch(e) {}
}

function loadState() {
  try {
    const saved = localStorage.getItem('ff_state');
    if (saved) {
      const parsed = JSON.parse(saved);
      Object.assign(state, parsed);
      return true;
    }
  } catch(e) {}
  return false;
}

// ============================================================
// PWA / INSTALL
// ============================================================
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('install-banner').style.display = 'flex';
});

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
      deferredPrompt = null;
      document.getElementById('install-banner').style.display = 'none';
    });
  }
}

// ============================================================
// BOOT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    document.getElementById('loading-overlay').classList.add('hidden');
    
    if (loadState() && state.workoutPlan) {
      document.getElementById('screen-onboard').classList.remove('active');
      document.getElementById('bottom-nav').style.display = 'flex';
      showScreen('home');
      updateHomeStats();
      renderWorkoutPlan();
      updateNutritionDisplay();
      renderFoodLog();
    }
  }, 1500);
});

// Register service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}

// Close modal on overlay click
document.getElementById('qty-modal').addEventListener('click', function(e) {
  if (e.target === this) closeQtyModal();
});

// Close food results on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.food-search-wrap')) {
    document.getElementById('food-results').style.display = 'none';
  }
});
</script>
</body>
</html>
